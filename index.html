<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC 小金庫</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .hidden { display: none; }
        button { margin: 5px; padding: 5px 10px; }
        table { border-collapse: collapse; width: 100%; }
        td, th { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>
    <h1>SC 小金庫</h1>

    <!-- 員工登入 -->
    <div id="employeeLogin" class="hidden">
        <h2>員工登入</h2>
        <input type="text" id="employeeLoginId" placeholder="員工號">
        <button onclick="loginEmployee()">登入</button>
        <p id="loginError" style="color: red;"></p>
    </div>

    <!-- 管理者登入 -->
    <div id="adminLogin" class="hidden">
        <h2>管理者登入</h2>
        <input type="text" id="adminUsername" placeholder="使用者名稱">
        <input type="password" id="adminPassword" placeholder="密碼">
        <button onclick="loginAdmin()">登入</button>
        <p id="adminError" style="color: red;"></p>
    </div>

    <!-- 員工頁面 -->
    <div id="employeePage" class="hidden">
        <h2>員工頁面</h2>
        <p>員工號: <input type="text" id="employeeId" readonly></p>
        <p>餘額: <span id="balance">0</span></p>
        <p>抽獎次數: <span id="lotteryChances">10</span></p>
        <button onclick="handleDeposit()">存款</button>
        <button onclick="performLottery()">抽獎</button>
        <button onclick="exportTransactions()">匯出交易紀錄</button>
        <button onclick="logoutEmployee()">登出</button>
        <p id="employeeMessage" style="color: green;"></p>
    </div>

    <!-- 管理者頁面 -->
    <div id="adminPage" class="hidden">
        <h2>管理者頁面</h2>
        <p>管理者: <span id="adminName"></span></p>
        <input type="text" id="adminEmployeeId" placeholder="員工號">
        <input type="number" id="adminAmount" placeholder="金額">
        <select id="adminType">
            <option value="存款">存款</option>
            <option value="提款">提款</option>
        </select>
        <button onclick="adminTransaction()">執行交易</button>
        <button onclick="deleteTransaction()">刪除交易</button>
        <button onclick="updateAdminTable()">更新表格</button>
        <button onclick="logoutAdmin()">登出</button>
        <table id="adminTable">
            <thead><tr><th>員工號</th><th>類型</th><th>金額</th><th>日期</th><th>餘額</th><th>管理員</th><th>備註</th></tr></thead>
            <tbody></tbody>
        </table>
        <p id="adminMessage" style="color: green;"></p>
    </div>

    <script>
        // Firebase 配置（請替換為您的實際配置）
        const firebaseConfig = {
            apiKey: "您的apiKey",
            authDomain: "您的authDomain",
            databaseURL: "https://sc-bank-6a55c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "您的projectId",
            storageBucket: "您的storageBucket",
            messagingSenderId: "您的messagingSenderId",
            appId: "您的appId"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let isEmployeeLoggedIn = false, isAdminLoggedIn = false;
        let currentEmployee = "", currentAdmin = "";

        // 員工登入
        function loginEmployee() {
            const employeeId = document.getElementById('employeeLoginId').value.trim();
            if (!employeeId) {
                showError("員工號不可為空", "login");
                return;
            }
            db.ref(`bankData/${employeeId}`).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    db.ref(`bankData/${employeeId}`).set({
                        deposits: [],
                        lotteryChances: 10,
                        lotteryAdmin: "",
                        lotteryNote: ""
                    }).then(() => {
                        isEmployeeLoggedIn = true;
                        currentEmployee = employeeId;
                        document.getElementById('employeeId').value = employeeId;
                        closeEmployeeLogin();
                        showPage('employeePage');
                        checkBalance();
                    });
                } else {
                    isEmployeeLoggedIn = true;
                    currentEmployee = employeeId;
                    document.getElementById('employeeId').value = employeeId;
                    closeEmployeeLogin();
                    showPage('employeePage');
                    checkBalance();
                }
            }).catch(error => showError(error.message, "login"));
        }

        // 管理者登入
        const ADMIN_CREDENTIALS = [
            { username: "Emma", password: "123" },
            { username: "Jennifer", password: "123" },
            { username: "Ivan", password: "123" },
            { username: "Celine", password: "123" }
        ];
        function loginAdmin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            if (!username || !password) {
                showError("使用者名稱和密碼不可為空", "admin");
                return;
            }
            if (ADMIN_CREDENTIALS.some(cred => cred.username === username && cred.password === password)) {
                isAdminLoggedIn = true;
                currentAdmin = username;
                document.getElementById('adminName').textContent = username;
                closeAdminLogin();
                showPage('adminPage');
                updateAdminTable();
            } else {
                showError("登入失敗：無效的帳號或密碼", "admin");
            }
        }

        // 檢查餘額
        function checkBalance() {
            db.ref(`bankData/${currentEmployee}`).once('value').then(snapshot => {
                const data = snapshot.val() || { deposits: [] };
                const balance = data.deposits.reduce((sum, deposit) => sum + deposit.amount, 0);
                document.getElementById('balance').textContent = balance;
                document.getElementById('lotteryChances').textContent = data.lotteryChances || 10;
            });
        }

        // 存款
        function handleDeposit() {
            const amount = prompt("請輸入存款金額:");
            if (amount && !isNaN(amount) && amount > 0) {
                const deposit = {
                    amount: parseFloat(amount),
                    depositDate: new Date().toLocaleString()
                };
                db.ref(`bankData/${currentEmployee}/deposits`).push(deposit).then(() => {
                    checkBalance();
                    showMessage("存款成功", "employee");
                });
            } else {
                showError("請輸入有效的金額", "employee");
            }
        }

        // 抽獎
        function performLottery() {
            db.ref(`bankData/${currentEmployee}/lotteryChances`).once('value').then(snapshot => {
                let chances = snapshot.val() || 0;
                if (chances > 0) {
                    chances -= 1;
                    db.ref(`bankData/${currentEmployee}/lotteryChances`).set(chances).then(() => {
                        checkBalance();
                        showMessage("抽獎成功，剩餘次數: " + chances, "employee");
                        // 模擬抽獎結果
                        const prize = Math.random() > 0.5 ? "獎金 100" : "未中獎";
                        alert(prize);
                    });
                } else {
                    showError("抽獎次數不足", "employee");
                }
            });
        }

        // 匯出交易紀錄
        function exportTransactions() {
            db.ref('transactions').orderByChild('employeeId').equalTo(currentEmployee).once('value').then(snapshot => {
                const transactions = snapshot.val() || {};
                const csv = convertToCSV(transactions);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'transactions.csv';
                a.click();
            });
        }

        // 管理者執行交易
        function adminTransaction() {
            const employeeId = document.getElementById('adminEmployeeId').value.trim();
            const amount = parseFloat(document.getElementById('adminAmount').value);
            const type = document.getElementById('adminType').value;
            if (employeeId && !isNaN(amount) && amount >= 0) {
                db.ref(`bankData/${employeeId}`).once('value').then(snapshot => {
                    const data = snapshot.val() || { deposits: [] };
                    const balance = data.deposits.reduce((sum, deposit) => sum + deposit.amount, 0);
                    const newBalance = type === "存款" ? balance + amount : balance - amount;
                    if (newBalance >= 0) {
                        const transaction = {
                            employeeId: employeeId,
                            type: type,
                            amount: amount,
                            date: new Date().toLocaleString(),
                            balance: newBalance,
                            admin: currentAdmin
                        };
                        db.ref('transactions').push(transaction).then(() => {
                            showMessage("交易成功", "admin");
                            updateAdminTable();
                        });
                    } else {
                        showError("餘額不足", "admin");
                    }
                });
            } else {
                showError("請輸入有效的員工號和金額", "admin");
            }
        }

        // 刪除交易
        function deleteTransaction() {
            const transactionId = prompt("請輸入要刪除的交易ID:");
            if (transactionId) {
                db.ref(`transactions/${transactionId}`).remove().then(() => {
                    showMessage("交易刪除成功", "admin");
                    updateAdminTable();
                }).catch(error => showError(error.message, "admin"));
            }
        }

        // 更新管理者表格
        function updateAdminTable() {
            db.ref('transactions').once('value').then(snapshot => {
                const transactions = snapshot.val() || {};
                const tbody = document.querySelector('#adminTable tbody');
                tbody.innerHTML = '';
                for (let id in transactions) {
                    const t = transactions[id];
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${t.employeeId}</td><td>${t.type}</td><td>${t.amount}</td><td>${t.date}</td><td>${t.balance}</td><td>${t.admin}</td><td>${t.note || ''}</td>`;
                }
            });
        }

        // 輔助函數
        function showPage(pageId) {
            document.querySelectorAll('div[id$="Page"]').forEach(div => div.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        function closeEmployeeLogin() {
            document.getElementById('employeeLogin').classList.add('hidden');
        }

        function closeAdminLogin() {
            document.getElementById('adminLogin').classList.add('hidden');
        }

        function showError(message, type) {
            document.getElementById(`${type}Error`).textContent = message;
        }

        function showMessage(message, type) {
            document.getElementById(`${type}Message`).textContent = message;
            setTimeout(() => document.getElementById(`${type}Message`).textContent = '', 3000);
        }

        function convertToCSV(objArray) {
            const array = Object.values(objArray);
            const headers = Object.keys(array[0] || {});
            const csv = [
                headers.join(','),
                ...array.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');
            return csv;
        }

        function logoutEmployee() {
            isEmployeeLoggedIn = false;
            currentEmployee = "";
            showPage('employeeLogin');
        }

        function logoutAdmin() {
            isAdminLoggedIn = false;
            currentAdmin = "";
            showPage('adminLogin');
        }

        // 初始顯示登入頁面
        showPage('employeeLogin');
    </script>
</body>
</html>
